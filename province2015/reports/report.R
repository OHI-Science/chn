# Ocean Health Index Report
# 'chn' is the name of the entire study area: it is all 11 regions combined
# 2015 is the year when the assessment is done

library(dplyr)
library(reshape2)


# options:
overwrite  = T
chn_only= F
do_flowers = T
do_tables  = T # tables not saved


# create directories
dir_report  = '~/github/chn/province2015/reports'
dir.create(dir_report, recursive=T, showWarnings=F)

# set viz options
ohi.options <- function() {
  double.digits <- 15 # <- floor(log10(.Machine$double.base^.Machine$double.digits))
  options(digits=double.digits)
  options(stringsAsFactors=FALSE) # to prevent factors
  options(width=120) # for outputting wide columns
  options(rstudio.markdownToHTML =
            function(inputFile, outputFile) {
              # example: eg /var/data/ohi/model/GL-NCEAS-Pressures_Matrix/report9.Rmd
              # see: http://www.rstudio.com/ide/docs/authoring/markdown_custom_rendering
              # original: '/Applications/RStudio.app/Contents/Resources/resources/markdown.css'
              markdownToHTML(inputFile, options=getOption('markdown.HTML.options'), outputFile, stylesheet=ohi.markdown.css)
            })
  options()
}
opt_old = options(ohi.options())

# get goals for flowers, all and specific to weights
goals.all = arrange(conf$goals, order_color)[['goal']]

# get colors for aster, based on 10 colors, but extended to all goals. subselect for goals.wts
cols.goals.all = colorRampPalette(RColorBrewer::brewer.pal(10, 'Spectral'), space='Lab')(length(goals.all))
names(cols.goals.all) = goals.all

# get subgoals and goals, not supragoals, for doing flower plot
goals_supra = na.omit(unique(conf$goals$parent))
wts = with(subset(conf$goals, !goal %in% goals_supra, c(goal, weight)), setNames(weight, goal))
goal_labels = gsub('\\n', '\n', with(conf$goals, setNames(name_flower, goal))[names(wts)], fixed=T)

# region names, ordered by GLOBAL and alphabetical
rgn_names = SelectLayersData(layers, layers=conf$config$layer_region_labels, narrow=T) %>%
  select(region_id = id_num,
         rgn_name  = val_chr)
rgn_names = rbind(data.frame(region_id=0, rgn_name='China'),
                  arrange(rgn_names, rgn_name))

# determine regions
if (chn_only){
  rgns = 0
} else {
  rgns = rgn_names$region_id
}

# directories to store figures and tables
dir_fig = file.path(dir_report, 'figures')
if(!dir.exists(dir_fig)) dir.create(dir_fig, showWarnings=F)

dir_tab = file.path(dir_report, 'tables')
if(!dir.exists(dir_tab)) dir.create(dir_tab, showWarnings=F)


# use factors to sort by goal and dimension in scores
conf$goals = arrange(conf$goals, order_hierarchy)
scores$goal_label = factor(
  scores$goal,
  levels = c('Index', conf$goals$goal),
  labels = c('Index', ifelse(!is.na(conf$goals$parent),
                             sprintf('. %s', conf$goals$name),
                             conf$goals$name)),ordered=T)
scores$dimension_label = factor(
  scores$dimension,
  levels = names(conf$config$dimension_descriptions),
  ordered=T)

# loop through regions
for (rgn_id in rgns){ # rgn_id=0

  # header md
  rgn_name = subset(rgn_names, region_id==rgn_id, rgn_name, drop=T)
  cat(sprintf('\n## %s (%d)\n\n', rgn_name, rgn_id))

  # flower plot ----
  if (do_flowers){

    # region scores
    x = with(subset(scores, dimension=='score' & region_id==rgn_id & goal %in% names(wts)),
             setNames(score, goal))[names(wts)]

    fig_pdf = sprintf('%s/flower_%s.pdf', dir_fig, gsub(' ','_', rgn_name))
    fig_png = sprintf('%s/flower_%s.png', dir_fig, gsub(' ','_', rgn_name))
    res=72
    if (overwrite | !file.exists(fig_png)){
      png(fig_png, width=res*7, height=res*7)
      PlotFlower(main = rgn_name,
                 lengths=x,
                 widths=wts,
                 fill.col=ifelse(is.na(x),
                                 'grey80',
                                 cols.goals.all[names(wts)]),
                 labels  =ifelse(is.na(x),
                                 paste(goal_labels, '-', sep='\n'),
                                 paste(goal_labels, round(x), sep='\n')),
                 center=round(weighted.mean(x, wts, na.rm=T)),
                 max.length = 100, disk=0.4, label.cex=0.9, label.offset=0.155, cex=2.2, cex.main=2.5)
      dev.off()
    }

    if (overwrite | !file.exists(fig_pdf)){
      pdf(fig_pdf, width=7, height=7)
      PlotFlower(main = rgn_name,
                 lengths=x,
                 widths=wts,
                 fill.col=ifelse(is.na(x),
                                 'grey80',
                                 cols.goals.all[names(wts)]),
                 labels  =ifelse(is.na(x),
                                 paste(goal_labels, '-', sep='\n'),
                                 paste(goal_labels, round(x), sep='\n')),
                 center=round(weighted.mean(x, wts, na.rm=T)),
                 max.length = 100, disk=0.4, label.cex=0.9, label.offset=0.155, cex=2.2, cex.main=2.5)
      dev.off()
    }

  }

  # table md
  if (do_tables){

    scores_csv = sprintf('%s/scores_%s.csv', dir_tab, gsub(' ','_', rgn_name))

    scores %>%
      filter(region_id == rgn_id) %>%
      select(goal_label, dimension_label, score) %>%
      spread(dimension_label, score) %>%
      dplyr::rename(' '=goal_label) %>%
      write.csv(scores_csv, row.names=F, na='')

  }
}

cat(sprintf('\nfigures and tables saved in %s\n\n', dir_report))

## This part should be automated and displayed on README:
### To calculate the percentage of local data vs. global data
setwd('~/github/chn/province2015')
layers = read.csv('layers.csv')
library(stringr)
local_data = layers %>%
  filter(str_detect(layers$filename, "chn"))
percent_local = round(nrow(local_data)/nrow(layers)*100, 2)
cat(sprintf('%s percent of all data was local \n', percent_local))

### Goal data
goal_data = filter(layers, !layers$target %in% c("pressures", "resilience", "spatial"))
local_data_goal = filter(goal_data, str_detect(goal_data$filename, "chn"))
percent_local_goal = round(nrow(local_data_goal)/nrow(goal_data)*100, 2)
cat(sprintf('%s percent of goal data was local \n', percent_local_goal))

### Pressure/Resilience data
pressure_data = filter(layers, str_detect(layers$targets, "pressures"))
local_pressure = filter(pressure_data, str_detect(pressure_data$filename, "chn"))
percent_local_press = nrow(local_pressure)/nrow(pressure_data) * 100
cat(sprintf('%s percent of pressures data was local \n', percent_local_press))

resilience_data = filter(layers, str_detect(layers$targets, "resilience"))
local_resilience = filter(resilience_data, str_detect(resilience_data$filename, "chn"))
percent_local_resilience = round(nrow(local_resilience)/nrow(resilience_data)*100, 2)
cat(sprintf('%s percent of resilience data was local \n', percent_local_resilience))
